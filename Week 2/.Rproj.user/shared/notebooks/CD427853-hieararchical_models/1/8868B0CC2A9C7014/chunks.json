{"chunk_definitions":[{"row":24,"row_count":1,"visible":true,"expansion_state":0,"options":{"include":false,"engine":"r","label":"setup","echo":false,"warning":false,"message":false},"document_id":"E4232474","chunk_id":"csetup_chunk","chunk_label":"setup"}],"doc_write_time":1616451471,"external_chunks":{"loadLibraries":["library(tidyverse)","library(rstanarm)","library(tidybayes)"],"loadUberRides":["df <- read_rds('data/uberRides.rds') %>%","  mutate(amount = abs(amount),","         logAmount = log(amount))","","minTrips <- 3","","dfStats <- df %>%","  group_by(userId) %>%","  summarize(nTrips = n(),","            avgLogPrice = mean(logAmount)) %>%","  filter(nTrips >= minTrips) %>%","  mutate(userIdF = factor(userId)) %>%","  ungroup() %>%","  mutate(empiricalRank = n() + 1 - min_rank(avgLogPrice))","","  ","","dfIncl <- df %>%","  filter(userId %in% dfStats$userId) %>%","  mutate(userIdF = factor(userId))"],"findTopRiders":["extremes <- bind_rows(","  dfStats %>%","  slice_max(avgLogPrice,n=20) %>%","  mutate(Position = 'Top 20'),","  dfStats %>%","  slice_min(avgLogPrice,n=20) %>%","  mutate(Position = 'Bottom 20')",")"],"plotUberStats":["overallMean <- mean(dfStats$avgLogPrice)","","dfStats %>%","  left_join(select(extremes,userId,Position), by = 'userId') %>%","  mutate(Position = replace_na(Position, 'Middle')) %>%","  ggplot(aes(x=nTrips,","             y=avgLogPrice,","             color = Position)) + geom_point(alpha=0.3) + geom_hline(aes(yintercept = overallMean)) +","  labs(x = 'Number of Trips',","       y = 'Average log(Trip Price)',","       title = 'Average Trip Price and Number of Trips') "],"uberModel1":["# M1_stan <- stan_glmer(logAmount ~ 1 + (1|userIdF),","#                      data = dfIncl,","#                      iter = 2000,","#                      chains = 1,","#                      seed = 349,","#                      prior_intercept = normal(0, 5),","#                      prior_aux = cauchy(0, 3))","# ","# saveRDS(M1_stan, file = 'data/M1.rds')","","M1_stan <- read_rds('data/M1.rds')","","alphaDraws <- M1_stan %>%","  spread_draws(`(Intercept)`, b[,user]) %>%","  mutate(alpha = `(Intercept)` + b) %>%","  separate(user, c(\"var\", \"userIdF\"), \":\") %>%","  select(-var) ","","alphaStats <- alphaDraws %>%","  group_by(userIdF) %>%","  median_qi(alpha) %>%","  left_join(select(dfStats,userIdF,avgLogPrice,nTrips), by = 'userIdF')"],"plotBayesEst1":["alphaStats %>%","  select(alpha,avgLogPrice,nTrips) %>%","  rename(Bayes = alpha, Regular = avgLogPrice) %>%","  pivot_longer(names_to = 'Estimate',values_to = 'Value',-nTrips) %>%","  ggplot(aes(x=nTrips,","             y=Value,","             color = Estimate)","         ) + geom_point(alpha=0.3) + geom_hline(aes(yintercept = overallMean)) + facet_wrap(~Estimate) + ","  labs(x = 'Number of Trips',","       y = 'alpha',","       title = 'Bayes User Estimates and Number of Trips') "],"plotBayesEst2":["alphaStats %>%","    select(alpha,avgLogPrice,nTrips) %>%","    ggplot(aes(x = avgLogPrice, y = alpha)) + geom_point(alpha=0.3, color ='red') + geom_abline(intercept = 0,slope = 1) + ","  labs(x = 'Regular Estimate',","       y = 'Bayes Estimate',","       title = 'Shrinkage Effect') "],"posteriorAlpha":["# plot posterior of alpha for a few select users ","","theUsers <- c(\"10003\",\"1002\",\"10082\",\"10181\")","","alphaDraws %>%","  filter(userIdF %in% theUsers) %>%","  ggplot(aes(x = alpha, fill = userIdF)) + geom_density(alpha=0.3) + ","  labs( x = 'alpha', title = 'Posterior for alpha for four users')","","","theStats <- alphaStats %>%","  select(-.width,-.point,-.interval) %>%","  filter(userIdF %in% theUsers)"],"posteriorRanking":["nUsers <- nrow(dfStats)","","postRanks <- alphaDraws %>%","  ungroup() %>%","  group_by(.draw) %>%","  mutate(rank = nUsers + 1 - min_rank(alpha))","","postRanksStats <- postRanks %>%","  group_by(userIdF) %>%","  summarize(meanRank = mean(rank),","            minRank = min(rank),","            maxRank = max(rank)) %>%","  left_join(select(dfStats,userIdF,nTrips,avgLogPrice,empiricalRank), by = 'userIdF')"],"retailData":["retail <- read_rds('data/storeSales.rds')","","","M2_stan <- stan_glmer(logVol ~ 1 + logFL + (1 + logFL|STORE_NUM),","                   data = retail,","                   iter = 500,","                   chains = 1,","                   seed = 349)","                   ","","saveRDS(M2_stan, file = 'data/M2.rds')","","allDraws <- M2_stan %>%","  spread_draws(`(Intercept)`,logFL, b[variable,store])","","alphaDraws <- allDraws %>%","  filter(variable == '(Intercept)') %>%","  mutate(alpha = `(Intercept)` + b)","","bDraws <- allDraws %>%","  ungroup() %>%","  filter(variable == 'logFL') %>%","  mutate(b = logFL + b) %>%","  select(.draw,store,b) %>%","  separate(store, c(\"tmp\", \"STORE_NUM\"), \":\") %>%","  select(-tmp)","","","bStats <- bDraws %>%","  group_by(STORE_NUM) %>%","  median_qi(b)","","bStats %>%","  ggplot(aes(x = fct_reorder(STORE_NUM,b), y = b, ymin = .lower, ymax = .upper)) + ","  geom_pointrange()"],"noShrinkageExample":["theSTORE <- \"11757\"","","M2_stan <- stan_glm(logVol ~ 1 + logFL,","                      data = filter(retail,STORE_NUM == theSTORE),","                      iter = 500,","                      chains = 1,","                      seed = 349)","","parDraws <- M2_stan %>%","  spread_draws(`(Intercept)`, logFL)","","median_qi(parDraws$logFL)"]},"working_dir":null,"default_chunk_options":{"echo":false,"warning":false,"message":false}}